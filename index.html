<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Appointment Booking</title>
  <style>
    :root{
      --primary:#0a66c2;
      --green:#2e8b57;        /* available */
      --red:#d93025;          /* unavailable */
      --yellow:#eab308;       /* booked */
      --blue:#2563eb;         /* selected */
      --muted:#b9bec5;        /* not configured */
      --border:#e6e8eb;
      --text:#1f2937;
      --bg:#fafafa;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Tahoma, sans-serif;
      background:var(--bg); color:var(--text);
      margin:0; padding:24px;
    }
    .container{ max-width:1040px; margin:0 auto; }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px;
    }
    .title{ font-size:18px; font-weight:800; }
    .refresh{
      border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:8px; cursor:pointer;
    }
    .refresh:hover{ background:#f3f4f6 }
    .grid{ display:grid; grid-template-columns:280px 1fr; gap:28px; align-items:start; }

    /* Calendar */
    .cal{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; width:280px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .cal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; padding:4px 2px; }
    .cal-head .month{ font-weight:800 }
    .cal-nav{ display:flex; gap:6px; }
    .btn-icon{
      width:28px; height:28px; border-radius:6px; border:1px solid var(--border); background:#fff; cursor:pointer;
      display:grid; place-items:center;
    }
    .btn-icon:hover{ background:#f3f4f6 }
    .week{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:12px; color:#6b7280; margin:6px 0 4px; text-align:center; }
    .days{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
    .day{
      height:34px; display:grid; place-items:center; border-radius:6px; font-size:13px; cursor:pointer; border:1px solid transparent;
      user-select:none;
    }
    .day:hover{ border-color:var(--border); background:#f8fafc }
    .day.muted{ color:#9aa0a6; cursor:default }
    .day.available{ background:#e9f7ef; color:#14532d; border-color:#d8efe2 }
    .day.selected{ background:#e0ecff; color:#0f3d91; border-color:#cfe2ff }
    .day.unavailable{ background:#fde8e6; color:#9b1c11; border-color:#f8cdc9; cursor:not-allowed }
    .day.booked{ background:#fff7db; color:#8a6a00; border-color:#ffeaa6; cursor:not-allowed }
    .legend{ font-size:12px; margin-top:10px; color:#6b7280; line-height:1.9; }
    .dot{display:inline-block; width:8px; height:8px; border-radius:50%; margin:0 6px -1px 6px;}
    .dot.green{background:var(--green)}
    .dot.red{background:var(--red)}
    .dot.yellow{background:var(--yellow)}
    .dot.blue{background:var(--blue)}
    .dot.gray{background:var(--muted)}

    /* Slots panel */
    .panel{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:18px 20px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .panel h3{ margin:0 0 14px; font-size:16px; }
    .slots{ display:flex; flex-direction:column; gap:18px; min-height:280px }
    .slot{
      display:flex; align-items:center; gap:10px; padding:8px 6px; cursor:pointer; border-radius:8px;
    }
    .slot:hover{ background:#f8fafc }
    .slot .time{ font-weight:700 }
    .slot .count{ color:#6b7280; font-size:12px }
    .slot .led{ width:9px; height:9px; border-radius:50%; background:var(--green) }
    .hr{ height:1px; background:var(--border); margin:18px 0 }
    .cta{ display:flex; justify-content:center; }
    .book{
      background:var(--primary); color:#fff; border:none; border-radius:8px; padding:12px 26px;
      font-weight:800; letter-spacing:.5px; cursor:pointer; min-width:160px;
    }
    .book:disabled{ background:#9aa0a6; cursor:not-allowed }
    .status{ margin-top:10px; min-height:22px; font-weight:700 }
    @media (max-width:880px){
      .grid{ grid-template-columns:1fr; }
      .cal{ width:100% }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Select an available date and time slot</div>
      <button class="refresh" id="refreshBtn">Refresh calendar â†»</button>
    </div>

    <div class="grid">
      <!-- Calendar -->
      <div class="cal" id="calendar">
        <div class="cal-head">
          <div class="cal-nav">
            <button class="btn-icon" id="prevMonth" aria-label="Previous month">â€¹</button>
          </div>
          <div class="month" id="monthLabel">â€”</div>
          <div class="cal-nav">
            <button class="btn-icon" id="nextMonth" aria-label="Next month">â€º</button>
          </div>
        </div>

        <div class="week">
          <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
        </div>
        <div class="days" id="days"></div>

        <div class="legend">
          <span class="dot green"></span> Available
          <span class="dot red"></span> Not available
          <span class="dot yellow"></span> Booked
          <span class="dot blue"></span> Selected day
          <span class="dot gray"></span> Days not configured
        </div>
      </div>

      <!-- Slots -->
      <div class="panel">
        <h3 id="panelTitle">Available time slots</h3>
        <div class="slots" id="slots">Loadingâ€¦</div>
        <div class="hr"></div>
        <div class="cta">
          <button class="book" id="bookBtn" disabled>BOOK</button>
        </div>
        <div class="status" id="status"></div>
      </div>
    </div>
  </div>

  <script>
    /*** Telegram Settings ***/
    const BOT_TOKEN    = "7544882164:AAHb67IVA8M3uUR3qfTRCxgFTUtS9tI8K7w";  // e.g. 123456789:ABCDEF...
    const OWNER_CHAT_ID= "6494466799";    // e.g. 123456789

    /*** Supported formats for the last message sent to your bot:
     *
     * 1) Preferred JSON:
     * {
     *   "days": {
     *     "2025-12-02": { "status":"available", "times":["09:30-09:45","10:00-10:15"] },
     *     "2025-12-03": { "status":"unavailable" },
     *     "2025-12-04": { "status":"booked" }
     *   }
     * }
     *
     * or:
     * { "slots":[
     *    {"date":"2025-12-02","times":["09:30-09:45","10:00-10:15"]},
     *    {"date":"2025-12-03","status":"unavailable"},
     *    {"date":"2025-12-04","status":"booked"}
     * ] }
     *
     * 2) Text fallback (pipe/comma separated):
     * AVAILABLE: 2025-12-02 09:30-09:45 | 2025-12-02 10:00-10:15
     * UNAVAILABLE_DAYS: 2025-12-03, 2025-12-10
     * BOOKED_DAYS: 2025-12-04, 2025-12-05
     */

    // UI state
    let dayMap = {}; // { 'YYYY-MM-DD': {status:'available'|'unavailable'|'booked'|'none', times?:string[]} }
    let current = new Date(); current.setDate(1);
    let selectedDate = null;
    let selectedTime = null;

    // Helpers
    const $ = s => document.querySelector(s);
    const pad = n => String(n).padStart(2,'0');
    const fmtKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const monthLabel = (y,m) => new Date(y,m,1).toLocaleDateString('en', {month:'long', year:'numeric'});

    /* -------- Fetch & Parse from Telegram -------- */
    async function fetchAppointments(){
      $("#slots").textContent = "Loadingâ€¦";
      $("#status").textContent = "";
      selectedDate = null; selectedTime = null; $("#bookBtn").disabled = true;

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
        const json = await res.json();
        const messages = (json.result || []).slice().reverse();

        let txt = "";
        for (const m of messages){
          const t = m?.message?.text?.trim();
          if (!t) continue;
          if (t.startsWith("{") && /"(days|slots)"/.test(t)) { txt = t; break; }
          if (/AVAILABLE:|UNAVAILABLE_DAYS:|BOOKED_DAYS:/.test(t)) { txt = t; break; }
        }
        if (!txt){ dayMap = {}; renderCalendar(); $("#slots").textContent = "No schedule found."; return; }

        dayMap = parseSchedule(txt);
        renderCalendar();
        autoSelectFirstAvailable();
      } catch (e){
        $("#slots").textContent = "Failed to fetch from Telegram. Check your BOT_TOKEN.";
      }
    }

    function parseSchedule(text){
      const map = {};
      // Try JSON first
      try {
        const j = JSON.parse(text);
        if (j.days && typeof j.days === 'object'){
          for (const [date, val] of Object.entries(j.days)){
            map[date] = { status: val.status || (val.times?.length ? 'available':'none'), times: val.times||[] };
          }
          return map;
        }
        if (Array.isArray(j.slots)){
          for (const it of j.slots){
            map[it.date] = { status: it.status || (it.times?.length ? 'available':'none'), times: it.times||[] };
          }
          return map;
        }
      } catch {}

      // Text fallback
      const lines = text.split(/\n+/).map(s=>s.trim());
      const avail = lines.find(l=>/^AVAILABLE:/i.test(l)) || "";
      const unavl = lines.find(l=>/^UNAVAILABLE_DAYS:/i.test(l)) || "";
      const booked = lines.find(l=>/^BOOKED_DAYS:/i.test(l)) || "";

      // AVAILABLE slots like: YYYY-MM-DD HH:MM-HH:MM | ...
      const availBody = avail.replace(/^AVAILABLE:/i,'').trim();
      availBody.split(/[|,ØŒ]+/).map(s=>s.trim()).filter(Boolean).forEach(p=>{
        const m = p.match(/(\d{4}-\d{2}-\d{2})\s+([0-2]\d:[0-5]\d-[0-2]\d:[0-5]\d)/);
        if (m){ const [_, d, t]=m; if(!map[d]) map[d]={status:'available',times:[]}; map[d].status='available'; map[d].times.push(t); }
      });

      const listFrom = (line) => line.replace(/^[A-Z_]+:/,'').trim().split(/[,\s]+/).map(s=>s.trim()).filter(v=>/^\d{4}-\d{2}-\d{2}$/.test(v));
      listFrom(unavl).forEach(d => map[d] = { status:'unavailable', times:[] });
      listFrom(booked).forEach(d => map[d] = { status:'booked', times:[] });

      // default non-configured days will be filled as 'none' during render
      return map;
    }

    /* -------- Calendar Render -------- */
    function renderCalendar(){
      $("#monthLabel").textContent = monthLabel(current.getFullYear(), current.getMonth());
      const daysEl = $("#days"); daysEl.innerHTML = "";
      const first = new Date(current.getFullYear(), current.getMonth(), 1);
      const startWeekday = (first.getDay()+6)%7; // Monday=0
      const daysInMonth = new Date(current.getFullYear(), current.getMonth()+1, 0).getDate();

      // leading blanks
      for (let i=0;i<startWeekday;i++){
        const d = document.createElement('div'); d.className='day muted'; daysEl.appendChild(d);
      }

      for (let day=1; day<=daysInMonth; day++){
        const el = document.createElement('div');
        el.className = 'day';
        const date = new Date(current.getFullYear(), current.getMonth(), day);
        const key = fmtKey(date);
        const info = dayMap[key] || { status:'none', times:[] };

        if (info.status === 'available'){
          el.classList.add('available');
        } else if (info.status === 'unavailable'){
          el.classList.add('unavailable');
        } else if (info.status === 'booked'){
          el.classList.add('booked');
        } else {
          el.classList.add('muted');
        }
        if (selectedDate === key) el.classList.add('selected');
        el.textContent = String(day);

        // clickability: only available days are selectable
        if (info.status === 'available'){
          el.addEventListener('click', ()=>{
            selectedDate = key; selectedTime = null;
            renderCalendar();
          });
        }
        daysEl.appendChild(el);
      }
      renderSlots();
    }

    /* -------- Slots Panel -------- */
    function renderSlots(){
      const list = $("#slots");
      list.innerHTML = "";
      $("#panelTitle").textContent = selectedDate ? `Time slots for ${selectedDate}` : "Available time slots";

      if (!selectedDate){
        list.textContent = "Pick a green day on the calendar to see available time slots.";
        $("#bookBtn").disabled = true;
        return;
      }
      const info = dayMap[selectedDate] || {status:'none', times:[]};

      if (info.status !== 'available'){
        list.textContent = info.status === 'booked'
          ? "This day is fully booked."
          : "This day is not available.";
        $("#bookBtn").disabled = true;
        return;
      }
      if (!info.times.length){
        list.textContent = "No time slots configured for this day.";
        $("#bookBtn").disabled = true;
        return;
      }

      info.times.forEach(t=>{
        const row = document.createElement('div');
        row.className = 'slot';
        row.innerHTML = `<span class="led"></span><span class="time">${t.replace('-', ' - ')}</span><span class="count">(1)</span>`;
        row.addEventListener('click', ()=>{
          [...document.querySelectorAll('.slot')].forEach(s=>s.style.background='');
          row.style.background = '#eef5ff';
          selectedTime = t;
          $("#bookBtn").disabled = false;
        });
        list.appendChild(row);
      });
    }

    function autoSelectFirstAvailable(){
      const keys = Object.keys(dayMap).filter(k=>dayMap[k].status==='available').sort();
      const firstThisMonth = keys.find(k=>{
        const [y,m] = k.split('-').map(Number);
        return y===current.getFullYear() && (m-1)===current.getMonth();
      }) || keys[0];
      if (firstThisMonth){ selectedDate = firstThisMonth; }
      renderCalendar();
    }

    /* -------- Booking through Telegram -------- */
    async function book(){
      if (!selectedDate || !selectedTime) return;
      const text = `ðŸ“¢ New Booking\nðŸ“… Date: ${selectedDate}\nâ° Time: ${selectedTime}`;
      $("#status").textContent = "Sending bookingâ€¦";
      try{
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ chat_id: OWNER_CHAT_ID, text })
        });
        if (!res.ok) throw new Error("sendMessage failed");
        $("#status").textContent = "âœ… Booking sent successfully.";
        // Optional UX improvement: mark the selected day as booked locally
        // dayMap[selectedDate].status = 'booked'; renderCalendar();
      }catch(e){
        $("#status").textContent = "âŒ Could not send booking. Check BOT_TOKEN and OWNER_CHAT_ID.";
      }
    }

    /* -------- UI Events -------- */
    $("#prevMonth").addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); renderCalendar(); });
    $("#nextMonth").addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); renderCalendar(); });
    $("#bookBtn").addEventListener('click', book);
    $("#refreshBtn").addEventListener('click', fetchAppointments);

    // boot
    fetchAppointments();
  </script>
</body>
</html>
