<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Appointment Booking</title>
  <style>
    :root{
      --primary:#0a66c2;
      --green:#2e8b57;        /* available */
      --red:#d93025;          /* unavailable / closed */
      --blue:#2563eb;         /* selected */
      --muted:#cfd3d8;        /* not configured */
      --text:#1f2937;
      --border:#e6e8eb;
      --bg:#ffffff;
      --panel:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Tahoma, sans-serif;
      background:#fafafa; color:var(--text);
      margin:0; padding:28px;
    }
    .wrap{ max-width:980px; margin:0 auto; }
    .dash{ text-align:center; color:#777; margin-bottom:6px; }
    .title{
      text-align:center; font-size:18px; font-weight:800; margin:0 0 18px;
    }
    .layout{
      display:grid; grid-template-columns:260px 1fr; gap:36px; align-items:start;
    }

    /* Calendar box */
    .calendar{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px 10px 14px;
      width:260px;
    }
    .cal-header{
      display:grid;
      grid-template-columns:24px 1fr 24px;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .month{
      text-align:center; font-weight:800; text-transform:lowercase;
    }
    .nav-btn{
      width:24px; height:24px; border-radius:4px; border:1px solid var(--border);
      background:#fff; cursor:pointer; line-height:22px; text-align:center; padding:0;
    }
    .week{
      display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:12px;
      color:#5f6b76; margin:6px 0 4px; text-align:center;
    }
    .days{
      display:grid; grid-template-columns:repeat(7,1fr); gap:4px;
    }
    .d{
      height:28px; display:grid; place-items:center; border-radius:4px; font-size:13px;
      border:1px solid transparent; user-select:none; cursor:pointer;
    }
    .d.muted{ background:#f3f4f6; color:#8b9198; cursor:default }
    .d.available{ background:#d5f0e1; color:#0e4d2b; border-color:#c8ead8 }
    .d.selected{ background:#dbe7ff; color:#0f3d91; border-color:#c9dcff }
    .d.unavailable{ background:#fbe2de; color:#8e1c10; border-color:#f6c7c1; cursor:not-allowed }
    .d.booked{ background:#fff3c4; color:#7c6200; border-color:#ffe395; cursor:not-allowed }
    .legend{
      margin-top:12px; font-size:12px; color:#5f6b76; line-height:1.9;
    }
    .dot{
      display:inline-block; width:8px; height:8px; border-radius:50%;
      margin:0 6px -1px 6px;
    }
    .dot.green{ background:var(--green) }
    .dot.red{ background:var(--red) }
    .dot.blue{ background:var(--blue) }
    .dot.gray{ background:var(--muted) }

    /* Slots panel to the right */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px 18px 16px;
    }
    .panel h3{ text-align:center; margin:4px 0 16px; }
    .slots{ display:flex; flex-direction:column; gap:22px; min-height:340px; }
    .slot{
      display:grid; grid-template-columns:14px 1fr; column-gap:8px; row-gap:4px; align-items:center;
    }
    .led{ width:8px; height:8px; border-radius:50%; background:var(--green); justify-self:center; }
    .time{ font-weight:700; }
    .count{ color:#68707a; font-size:12px; padding-inline-start:22px; }
    .hr{ height:1px; background:var(--border); margin:20px 0; }
    .cta{ display:flex; justify-content:center; }
    .book{
      background:#1e63c8; color:#fff; border:none; border-radius:3px; width:240px;
      padding:10px 0; font-weight:800; letter-spacing:.3px; cursor:pointer;
    }
    .book:disabled{ background:#9aa0a6; cursor:not-allowed }
    .status{ min-height:22px; text-align:center; font-weight:700; margin-top:8px; }

    @media (max-width:860px){
      .layout{ grid-template-columns:1fr; gap:18px; }
      .calendar{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="dash">-</div>
    <h2 class="title">Select an available date and time slot</h2>

    <div class="layout">
      <!-- Calendar -->
      <div class="calendar">
        <div class="cal-header">
          <button class="nav-btn" id="prev">&lt;</button>
          <div class="month" id="monthLabel">dicembre 2025</div>
          <button class="nav-btn" id="next">&gt;</button>
        </div>
        <div class="week">
          <div>lu</div><div>ma</div><div>me</div><div>gi</div><div>ve</div><div>sa</div><div>do</div>
        </div>
        <div class="days" id="days"></div>

        <div class="legend">
          <span class="dot green"></span> Available
          <span class="dot red"></span> Not available
          <span class="dot blue"></span> Day selected
          <span class="dot gray"></span> Days not configured
        </div>
      </div>

      <!-- Slots -->
      <div class="panel">
        <h3 id="panelTitle"></h3>
        <div class="slots" id="slots">Loadingâ€¦</div>
        <div class="hr"></div>
        <div class="cta">
          <button class="book" id="bookBtn" disabled>BOOK</button>
        </div>
        <div class="status" id="status"></div>
      </div>
    </div>
  </div>

  <script>
    /*** Telegram settings ***/
    const BOT_TOKEN     = "7544882164:AAHb67IVA8M3uUR3qfTRCxgFTUtS9tI8K7w";   // e.g. 123456789:ABCDEF...
    const OWNER_CHAT_ID = "6494466799";     // e.g. 123456789

    /*** Supported schedule message formats (send one of these to your bot):
     *  1) JSON (recommended):
     *  {
     *    "days": {
     *      "2025-12-01": { "status":"available", "times":["09:30-09:45","10:00-10:15","10:30-10:45","11:00-11:15","11:30-11:45","12:30-12:45"] },
     *      "2025-12-04": { "status":"unavailable" },
     *      "2025-12-25": { "status":"unavailable" },
     *      "2025-12-03": { "status":"booked" }
     *    }
     *  }
     *
     *  2) Text fallback:
     *  AVAILABLE: 2025-12-01 09:30-09:45 | 2025-12-01 10:00-10:15 | 2025-12-01 10:30-10:45 | 2025-12-01 11:00-11:15 | 2025-12-01 11:30-11:45 | 2025-12-01 12:30-12:45
     *  UNAVAILABLE_DAYS: 2025-12-04, 2025-12-25
     *  BOOKED_DAYS: 2025-12-03
     */

    // ---- State
    let dayMap = {};  // { date: {status:'available'|'unavailable'|'booked'|'none', times:[] } }
    let current = new Date(); current.setDate(1);
    let selectedDate = null;
    let selectedTime = null;

    // ---- Helpers
    const $=s=>document.querySelector(s);
    const pad=n=>String(n).padStart(2,'0');
    const keyOf = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const monthIt = (y,m) => new Date(y,m,1).toLocaleDateString('it-IT',{month:'long',year:'numeric'});

    // ---- Telegram fetch & parse
    async function loadFromTelegram(){
      $("#slots").textContent = "Loadingâ€¦";
      $("#status").textContent = "";
      selectedDate=null; selectedTime=null; $("#bookBtn").disabled=true;

      try{
        const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
        const j = await r.json();
        const msgs = (j.result || []).slice().reverse();
        let txt = "";
        for (const m of msgs){
          const t = m?.message?.text?.trim();
          if (!t) continue;
          if (t.startsWith("{") && /"(days|slots)"/.test(t)) { txt = t; break; }
          if (/AVAILABLE:|UNAVAILABLE_DAYS:|BOOKED_DAYS:/i.test(t)) { txt = t; break; }
        }
        if (!txt){ dayMap={}; render(); $("#slots").textContent = "No schedule found."; return; }
        dayMap = parseSchedule(txt);
        render();
        autoSelectFirstAvailable();
      }catch(e){
        $("#slots").textContent = "Failed to fetch from Telegram. Check BOT_TOKEN.";
      }
    }

    function parseSchedule(text){
      const map = {};
      // JSON first
      try{
        const j = JSON.parse(text);
        if (j.days){
          for (const [d,val] of Object.entries(j.days)){
            map[d] = { status: val.status || (val.times?.length?'available':'none'), times: val.times||[] };
          }
          return map;
        }
        if (Array.isArray(j.slots)){
          for (const it of j.slots){
            map[it.date] = { status: it.status || (it.times?.length?'available':'none'), times: it.times||[] };
          }
          return map;
        }
      }catch{}
      // Text fallback
      const lines = text.split(/\n+/).map(s=>s.trim());
      const avail = (lines.find(l=>/^AVAILABLE:/i.test(l))||"").replace(/^AVAILABLE:/i,'').trim();
      const unavl = (lines.find(l=>/^UNAVAILABLE_DAYS:/i.test(l))||"").replace(/^UNAVAILABLE_DAYS:/i,'').trim();
      const booked = (lines.find(l=>/^BOOKED_DAYS:/i.test(l))||"").replace(/^BOOKED_DAYS:/i,'').trim();

      avail.split(/[|,ØŒ]+/).map(s=>s.trim()).filter(Boolean).forEach(p=>{
        const m = p.match(/(\d{4}-\d{2}-\d{2})\s+([0-2]\d:[0-5]\d-[0-2]\d:[0-5]\d)/);
        if (m){ const [_,d,t]=m; if(!map[d]) map[d]={status:'available',times:[]}; map[d].times.push(t); }
      });
      unavl.split(/[,\s]+/).map(s=>s.trim()).filter(v=>/^\d{4}-\d{2}-\d{2}$/.test(v)).forEach(d=> map[d]={status:'unavailable',times:[]});
      booked.split(/[,\s]+/).map(s=>s.trim()).filter(v=>/^\d{4}-\d{2}-\d{2}$/.test(v)).forEach(d=> map[d]={status:'booked',times:[]});

      return map;
    }

    // ---- Rendering
    function render(){
      $("#monthLabel").textContent = monthIt(current.getFullYear(), current.getMonth());
      const first = new Date(current.getFullYear(), current.getMonth(), 1);
      const start = (first.getDay()+6)%7; // Monday=0
      const daysIn = new Date(current.getFullYear(), current.getMonth()+1, 0).getDate();
      const box = $("#days");
      box.innerHTML = "";

      for (let i=0;i<start;i++){
        const e = document.createElement('div');
        e.className = 'd muted';
        e.textContent = '';
        box.appendChild(e);
      }

      for (let day=1; day<=daysIn; day++){
        const e = document.createElement('div');
        const d = new Date(current.getFullYear(), current.getMonth(), day);
        const k = keyOf(d);
        const info = dayMap[k] || {status:'none',times:[]};

        e.className = 'd';
        if (info.status==='available') e.classList.add('available');
        else if (info.status==='unavailable') e.classList.add('unavailable');
        else if (info.status==='booked') e.classList.add('booked');
        else e.classList.add('muted');
        if (selectedDate===k) e.classList.add('selected');

        e.textContent = String(day);

        if (info.status==='available'){
          e.addEventListener('click', ()=>{
            selectedDate=k; selectedTime=null; renderSlots();
            document.querySelectorAll('.d').forEach(x=>x.classList.remove('selected'));
            e.classList.add('selected');
          });
        } else {
          e.style.pointerEvents = 'none';
        }
        box.appendChild(e);
      }
      renderSlots();
    }

    function renderSlots(){
      const list = $("#slots");
      list.innerHTML = "";
      $("#panelTitle").textContent = " ";

      if (!selectedDate){
        list.textContent = "Select a green day on the calendar to view time slots.";
        $("#bookBtn").disabled = true; return;
      }
      const info = dayMap[selectedDate] || {status:'none',times:[]};
      if (info.status!=='available'){
        list.textContent = info.status==='booked' ? "This day is fully booked." : "This day is not available.";
        $("#bookBtn").disabled = true; return;
      }
      if (!info.times.length){
        list.textContent = "No time slots configured for this day.";
        $("#bookBtn").disabled = true; return;
      }

      info.times.forEach(t=>{
        const row = document.createElement('div');
        row.className = 'slot';
        row.innerHTML = `<span class="led"></span><div class="time">${t.replace('-', ' - ')}</div><div class="count">(1)</div>`;
        row.style.cursor = 'pointer';
        row.addEventListener('click', ()=>{
          [...document.querySelectorAll('.slot')].forEach(s=>s.style.background='');
          row.style.background = '#f5f7fb';
          selectedTime = t;
          $("#bookBtn").disabled=false;
        });
        list.appendChild(row);
      });
    }

    function autoSelectFirstAvailable(){
      const keys = Object.keys(dayMap).filter(k=>dayMap[k].status==='available').sort();
      const inMonth = keys.find(k=>{
        const [y,m] = k.split('-').map(Number);
        return y===current.getFullYear() && (m-1)===current.getMonth();
      }) || keys[0];
      if (inMonth){ selectedDate=inMonth; }
      render();
    }

    // ---- Booking (Telegram)
    async function book(){
      if (!selectedDate || !selectedTime) return;
      const text = `ðŸ“¢ New Booking\nðŸ“… Date: ${selectedDate}\nâ° Time: ${selectedTime}`;
      $("#status").textContent = "Sendingâ€¦";
      try{
        const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ chat_id: OWNER_CHAT_ID, text })
        });
        if (!r.ok) throw new Error("sendMessage failed");
        $("#status").textContent = "âœ… Booking sent successfully.";
      }catch(e){
        $("#status").textContent = "âŒ Could not send booking. Check BOT_TOKEN and OWNER_CHAT_ID.";
      }
    }

    // ---- Events
    $("#prev").addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); render(); });
    $("#next").addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); render(); });
    $("#bookBtn").addEventListener('click', book);

    // Start
    loadFromTelegram();
  </script>
</body>
</html>
