<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New Visit</title>
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.12);
      --glass-bg-hover: rgba(255, 255, 255, 0.22);
      --danger: #ff5252;
      --ok: #22c55e;
    }
    * {
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top, #00c6ff 0, #007aff 45%, #001b4d 100%);
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    h1 {
      font-size: 2.4rem;
      font-weight: 700;
      margin: 0 0 18px;
      text-shadow: 0 10px 25px rgba(0,0,0,.3);
      text-align: center;
      animation: fadeInDown .8s ease;
    }
    form {
      width: 100%;
      max-width: 560px;
      background: var(--glass-bg);
      border-radius: 18px;
      padding: 20px 20px 22px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      animation: fadeInUp .9s ease;
      position: relative;
      overflow: hidden;
    }
    label {
      display: block;
      font-weight: 600;
      margin: 12px 6px 6px;
      font-size: 0.92rem;
    }
    .req {
      opacity: .9;
    }
    input[type=text],
    input[type=tel],
    input[type=file],
    select {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.28);
      outline: none;
      background: rgba(5, 28, 70, 0.5);
      color: #fff;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }
    input::placeholder {
      color: rgba(255, 255, 255, 0.55);
    }
    select {
      cursor: pointer;
    }
    input[type=text]:focus,
    input[type=tel]:focus,
    input[type=file]:focus,
    select:focus {
      border-color: #fff;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.55);
      background: rgba(5, 28, 70, 0.75);
    }
    .row {
      display: flex;
      flex-direction: column;
      gap: 10px 16px;
    }
    .row > div {
      flex: 1;
      min-width: 0;
    }
    @media (min-width: 640px) {
      .row {
        flex-direction: row;
      }
    }

    .error {
      color: #ffd0d0;
      font-size: 0.78rem;
      margin: 4px 6px 0;
      display: none;
    }
    .error.show {
      display: block;
    }
    input.invalid,
    select.invalid {
      border-color: var(--danger);
      box-shadow: 0 0 0 1px rgba(255, 82, 82, 0.6);
    }

    button[type=submit] {
      width: 100%;
      margin-top: 16px;
      padding: 11px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #f9fff9;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }
    button[type=submit]:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 16px 38px rgba(0, 0, 0, 0.55);
    }
    button[type=submit]:disabled {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
    }

    .hint {
      font-size: 0.78rem;
      opacity: 0.85;
      margin: 4px 6px 0;
    }

    /* Toast */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%) translateY(100%);
      background: rgba(15, 23, 42, 0.96);
      color: #f9fafb;
      padding: 10px 16px;
      border-radius: 999px;
      box-shadow: 0 16px 35px rgba(0, 0, 0, 0.5);
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: all 0.25s ease;
      z-index: 999;
      max-width: 90%;
      text-align: center;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Success checkmark */
    .checkmark {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }
    .checkmark.show {
      opacity: 1;
    }
    .checkmark svg {
      width: 72px;
      height: 72px;
      filter: drop-shadow(0 12px 25px rgba(0, 0, 0, 0.6));
    }

    /* Confetti canvas */
    #confettiCanvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 500;
    }

    /* Form success glow */
    .form-success {
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.6), 0 18px 45px rgba(0, 0, 0, 0.5);
      animation: successPulse 1.1s ease-out;
    }

    @keyframes successPulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.0); }
      40% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0.35); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.0); }
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-18px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h1>Welcome</h1>

  <canvas id="confettiCanvas"></canvas>

  <form id="visit-form" novalidate>
    <div class="row">
      <div>
        <label for="fullName">Full Name <span class="req">*</span></label>
        <input id="fullName" name="fullName" type="text" placeholder="Full Name" autocomplete="name" required />
        <div id="errName" class="error">Please enter a valid full name (3 characters or more).</div>
      </div>
      <div>
        <label for="passport">Passport Number <span class="req">*</span></label>
        <input id="passport" name="passport" type="text" pattern="[A-Za-z0-9]{6,12}" placeholder="Passport Number" required />
        <div id="errPass" class="error">Passport must be 6â€“12 letters or digits (Aâ€“Z, 0â€“9).</div>
      </div>
    </div>

    <!-- Phone row -->
    <div class="row">
      <div>
        <label for="countryCode">Country Code <span class="req">*</span></label>
        <select id="countryCode" name="countryCode" required>
          <option value="+212" selected>ğŸ‡²ğŸ‡¦ Morocco (+212)</option>
          <option value="+33">ğŸ‡«ğŸ‡· France (+33)</option>
          <option value="+34">ğŸ‡ªğŸ‡¸ Spain (+34)</option>
          <option value="+39">ğŸ‡®ğŸ‡¹ Italy (+39)</option>
          <option value="+49">ğŸ‡©ğŸ‡ª Germany (+49)</option>
          <option value="+44">ğŸ‡¬ğŸ‡§ United Kingdom (+44)</option>
          <option value="+1">ğŸ‡ºğŸ‡¸ğŸ‡¨ğŸ‡¦ USA / Canada (+1)</option>
          <option value="+971">ğŸ‡¦ğŸ‡ª UAE (+971)</option>
          <option value="+966">ğŸ‡¸ğŸ‡¦ Saudi Arabia (+966)</option>
          <option value="+20">ğŸ‡ªğŸ‡¬ Egypt (+20)</option>
        </select>
      </div>
      <div>
        <label for="phone">Phone Number <span class="req">*</span></label>
        <input id="phone" name="phone" type="tel" placeholder="612345678" autocomplete="tel" required />
        <div id="errPhone" class="error">Please enter a valid phone number (digits only).</div>
        <div class="hint">Write the number without the country code (it will be added automatically).</div>
      </div>
    </div>

    <label for="pdf">Passport File <span class="req">*</span></label>
    <input id="pdf" name="pdf" type="file" accept="application/pdf,image/*" required />
    <div id="errFile" class="error">Please upload a PDF, JPG, PNG or WebP file up to 20MB.</div>
    <div class="hint">Accepted: PDF, JPG, PNG, WebP (max 20MB).</div>

    <button id="sendBtn" type="submit">Send</button>

    <div class="checkmark" id="checkmark">
      <svg viewBox="0 0 52 52">
        <circle cx="26" cy="26" r="25" fill="#22c55e"/>
        <path d="M14 27l7 7 17-17" fill="none" stroke="#fff" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </form>

  <div id="toast"></div>

  <script>
    const API_ENDPOINT = "https://api.mehdik.site/"; // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Worker Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ùˆ Ù…Ø®ØªÙ„Ù

    const form = document.getElementById('visit-form');
    const sendBtn = document.getElementById('sendBtn');
    const toastEl = document.getElementById('toast');
    const checkmarkEl = document.getElementById('checkmark');
    const confettiCanvas = document.getElementById('confettiCanvas');
    const ctx = confettiCanvas.getContext('2d');

    const nameInput = document.getElementById('fullName');
    const passInput = document.getElementById('passport');
    const ccInput   = document.getElementById('countryCode');
    const phoneInput = document.getElementById('phone');
    const fileInput = document.getElementById('pdf');

    const errName = document.getElementById('errName');
    const errPass = document.getElementById('errPass');
    const errPhone = document.getElementById('errPhone');
    const errFile = document.getElementById('errFile');

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 2600);
    }

    function validate() {
      let valid = true;

      function clear(el, err) {
        el.classList.remove('invalid');
        err.classList.remove('show');
      }
      function fail(el, err) {
        el.classList.add('invalid');
        err.classList.add('show');
        valid = false;
      }

      clear(nameInput, errName);
      clear(passInput, errPass);
      clear(ccInput, errPhone); // phone errors use same style
      clear(phoneInput, errPhone);
      clear(fileInput, errFile);

      const nameVal = (nameInput.value || '').trim();
      if (nameVal.length < 3) {
        fail(nameInput, errName);
      }

      const passVal = (passInput.value || '').trim();
      const passRe = /^[A-Za-z0-9]{6,12}$/;
      if (!passRe.test(passVal)) {
        fail(passInput, errPass);
      }

      const ccVal = (ccInput.value || '').trim();
      const ccRe = /^\+\d{1,4}$/;
      if (!ccRe.test(ccVal)) {
        fail(ccInput, errPhone);
      }

      let phoneVal = (phoneInput.value || '').trim().replace(/\s+/g, '');
      const phoneRe = /^\d{6,15}$/;
      if (!phoneRe.test(phoneVal)) {
        fail(phoneInput, errPhone);
      }

      const f = fileInput.files[0];
      if (!f) {
        fail(fileInput, errFile);
      } else {
        const allowed = [
          'application/pdf',
          'image/jpeg',
          'image/png',
          'image/webp'
        ];
        if (!allowed.includes(f.type) || f.size > 20 * 1024 * 1024) {
          fail(fileInput, errFile);
        }
      }

      return valid;
    }

    async function sendToServer(formEl) {
      const fd = new FormData(formEl);
      // Optionally send fullPhone as one field too
      const ccVal = (ccInput.value || '').trim();
      let phoneVal = (phoneInput.value || '').trim().replace(/\s+/g, '');
      fd.append('fullPhone', ccVal + ' ' + phoneVal);

      const res = await fetch(API_ENDPOINT, {
        method: 'POST',
        body: fd,
      });

      let data = null;
      try {
        data = await res.json();
      } catch (e) {
        throw new Error('Invalid response from server.');
      }

      if (!res.ok || !data.ok) {
        throw new Error(data && data.error ? data.error : 'Server returned an error');
      }
    }

    // Confetti
    let confettiPieces = [];
    function resizeCanvas() {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function spawnConfetti() {
      confettiPieces = [];
      for (let i = 0; i < 140; i++) {
        confettiPieces.push({
          x: Math.random() * confettiCanvas.width,
          y: Math.random() * confettiCanvas.height - confettiCanvas.height,
          w: 5 + Math.random() * 5,
          h: 8 + Math.random() * 8,
          vy: 2 + Math.random() * 4,
          rot: Math.random() * Math.PI * 2,
          vr: (Math.random() - 0.5) * 0.2
        });
      }
    }

    function drawConfetti() {
      ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      confettiPieces.forEach(p => {
        p.y += p.vy;
        p.rot += p.vr;
        if (p.y - p.h > confettiCanvas.height) {
          p.y = -p.h;
        }
        const hue = 140 + (p.x / confettiCanvas.width) * 140;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
        ctx.restore();
      });
    }

    let confettiAnim = null;
    function runConfetti(duration = 1800) {
      spawnConfetti();
      const start = performance.now();

      function frame(now) {
        const elapsed = now - start;
        drawConfetti();
        if (elapsed < duration) {
          confettiAnim = requestAnimationFrame(frame);
        } else {
          ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
          confettiAnim = null;
        }
      }
      if (confettiAnim) cancelAnimationFrame(confettiAnim);
      confettiAnim = requestAnimationFrame(frame);
    }

    function successFX() {
      form.classList.add('form-success');
      checkmarkEl.classList.add('show');
      runConfetti();

      setTimeout(() => {
        form.classList.remove('form-success');
        checkmarkEl.classList.remove('show');
      }, 1800);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validate()) {
        showToast('âš ï¸ Please check your inputs and try again.');
        return;
      }
      try {
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sendingâ€¦';
        await sendToServer(form);
        showToast('âœ… Sent successfully.');
        successFX();
        form.reset();
      } catch (err) {
        console.error(err);
        showToast('âŒ Sending failed. Try again later.');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    });
  </script>
</body>
</html>
