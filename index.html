<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</title>
  <style>
    body {
      font-family: 'Tahoma', sans-serif;
      background: #f8f9fb;
      color: #333;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    header {
      background: #0078d4;
      color: white;
      padding: 1rem;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 2rem;
      gap: 3rem;
      flex-wrap: wrap;
    }

    #calendar {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: white;
    }

    table {
      border-collapse: collapse;
      margin: 10px auto;
    }

    th, td {
      width: 40px;
      height: 40px;
      text-align: center;
      cursor: pointer;
      border-radius: 5px;
      transition: 0.2s;
    }

    td:hover { background: #e8f0fe; }
    .available { background: #4caf50; color: white; }
    .unavailable { background: #f44336; color: white; }
    .selected { background: #0078d4; color: white; }

    #slots {
      background: white;
      padding: 20px;
      border-radius: 10px;
      min-width: 250px;
      border: 1px solid #ddd;
    }

    .slot {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 6px 0;
      cursor: pointer;
      transition: 0.2s;
    }

    .slot:hover { background: #0078d4; color: white; }

    button {
      background: #0078d4;
      color: white;
      border: none;
      padding: 10px 25px;
      font-size: 16px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background: #005fa3; }

    #message { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <header><h1>ğŸ“… Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h1></header>

  <div class="container">
    <div id="calendar">
      <h3 id="month-year"></h3>
      <table id="calendar-table"></table>
      <button onclick="getAvailableAppointments()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</button>
    </div>

    <div id="slots">
      <h3>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
      <div id="slot-list">Ø§Ø®ØªØ± ÙŠÙˆÙ…Ù‹Ø§ Ù…Ù† Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</div>
      <button id="book-btn" onclick="bookSelectedSlot()" disabled>Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
      <div id="message"></div>
    </div>
  </div>

  <script>
    const BOT_TOKEN = "7544882164:AAHb67IVA8M3uUR3qfTRCxgFTUtS9tI8K7w";
    const OWNER_CHAT_ID = "6494466799";

    let availableSlots = {};
    let selectedDate = null;
    let selectedSlot = null;

    async function getAvailableAppointments() {
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
      const data = await res.json();
      const messages = data.result.reverse();

      const lastMessage = messages.find(m => m.message?.text?.includes("Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯"));
      if (!lastMessage) {
        document.getElementById("slot-list").innerText = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯.";
        return;
      }

      const text = lastMessage.message.text.replace("Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:", "").trim();
      const lines = text.split("\n").filter(Boolean);

      availableSlots = {};
      for (const line of lines) {
        const [date, times] = line.split(":");
        if (date && times) {
          availableSlots[date.trim()] = times.split(",").map(t => t.trim());
        }
      }

      buildCalendar();
      document.getElementById("slot-list").innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯.";
    }

    function buildCalendar() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const table = document.getElementById("calendar-table");
      const header = document.getElementById("month-year");
      header.innerText = now.toLocaleString("ar", { month: "long", year: "numeric" });
      table.innerHTML = "";

      const weekdays = ["Ø£", "Ø¥", "Ø«", "Ø£Ø±", "Ø®", "Ø¬", "Ø³"];
      const rowHeader = document.createElement("tr");
      weekdays.forEach(d => {
        const th = document.createElement("th");
        th.innerText = d;
        rowHeader.appendChild(th);
      });
      table.appendChild(rowHeader);

      let row = document.createElement("tr");
      for (let i = 0; i < firstDay; i++) row.appendChild(document.createElement("td"));

      for (let d = 1; d <= daysInMonth; d++) {
        const td = document.createElement("td");
        const dateStr = `${d}/${month + 1}/${year}`;
        td.innerText = d;

        if (availableSlots[dateStr]) td.classList.add("available");

        td.onclick = () => selectDate(dateStr, td);

        row.appendChild(td);
        if ((firstDay + d) % 7 === 0) {
          table.appendChild(row);
          row = document.createElement("tr");
        }
      }
      table.appendChild(row);
    }

    function selectDate(dateStr, cell) {
      document.querySelectorAll("#calendar td").forEach(td => td.classList.remove("selected"));
      cell.classList.add("selected");
      selectedDate = dateStr;

      const slotList = document.getElementById("slot-list");
      slotList.innerHTML = "";
      selectedSlot = null;
      document.getElementById("book-btn").disabled = true;

      const slots = availableSlots[dateStr] || [];
      if (slots.length === 0) {
        slotList.innerText = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….";
        return;
      }

      slots.forEach(slot => {
        const div = document.createElement("div");
        div.className = "slot";
        div.innerText = slot;
        div.onclick = () => selectSlot(slot, div);
        slotList.appendChild(div);
      });
    }

    function selectSlot(slot, div) {
      document.querySelectorAll(".slot").forEach(s => s.style.background = "");
      div.style.background = "#0078d4";
      div.style.color = "white";
      selectedSlot = slot;
      document.getElementById("book-btn").disabled = false;
    }

    async function bookSelectedSlot() {
      if (!selectedSlot || !selectedDate) return;

      const msgEl = document.getElementById("message");
      msgEl.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¬Ø²...";

      const text = `ğŸ“¢ ØªÙ… Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯:\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${selectedDate}\nğŸ• Ø§Ù„ÙˆÙ‚Øª: ${selectedSlot}`;
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: OWNER_CHAT_ID, text })
      });

      if (res.ok) msgEl.innerText = "âœ… ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!";
      else msgEl.innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø².";
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    getAvailableAppointments();
  </script>
</body>
</html>
